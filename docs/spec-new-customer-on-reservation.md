# SPEC: 예약 시 신규 고객 자동 등록 개선

## 배경

현재 "새 예약" 폼에서 "신규 고객 입력" 모드로 예약 생성 시, 고객 데이터도 함께 등록되도록 기능이 추가되었다.
그러나 동일 전화번호가 이미 존재하는 경우의 처리가 미흡하다.

### 현재 동작
1. 신규 고객 모드에서 전화번호 입력 → 예약 생성 시 `customerApi.getByPhone()` 으로 중복 확인
2. 중복이면 고객 등록 건너뜀 → 예약만 생성
3. 중복이 아니면 고객 등록 후 → 예약 생성

### 문제점
- 사용자가 동일 전화번호의 기존 고객이 있는지 모른 채 진행됨
- 기존 고객 정보가 변경되었을 수 있으나 업데이트할 수 없음
- 동명이인 등의 경우 신규 등록이 불가능

---

## 요구사항

### 핵심 UX 흐름

```
전화번호 입력
    ↓ (debounce 500ms)
기존 고객 조회
    ↓
[일치하는 고객 없음] → 그대로 진행 (예약+고객 자동 등록)
[일치하는 고객 있음] → 인라인 알림 표시
    ├─ [기존 고객 선택] → 기존 고객 정보로 폼 채움
    └─ [무시하고 계속] → 새 고객으로 등록하지 않고 예약만 생성
```

### 상세 기능

#### 1. 전화번호 입력 시 실시간 기존 고객 조회
- **위치**: AppointmentForm > "신규 고객 입력" 모드 > 전화번호 필드
- **트리거**: 전화번호 입력 후 500ms debounce
- **조건**: 전화번호가 4자리 이상일 때만 조회
- **API**: `customerApi.getByPhone(phone)`

#### 2. 기존 고객 발견 시 인라인 알림
- **위치**: 전화번호 입력 필드 바로 아래
- **표시 정보**:
  - 고객 전화번호
  - 고객 이름
  - 방문 횟수 (예: "3회 방문")
- **액션 버튼**: "기존 고객 선택" 버튼
- **스타일**: `bg-blue-50 border-blue-200` 계열의 정보 알림 스타일

#### 3. "기존 고객 선택" 동작
- 기존 고객 정보로 폼 필드 채움:
  - `customerName` ← 기존 고객 이름
  - `customerPhone` ← 기존 고객 전화번호
  - `designerId` ← 기존 고객 선호 디자이너 (있으면)
  - `serviceType` ← 기존 고객 선호 서비스 (있으면)
- `selectedCustomer` 상태 설정 (알레르기 정보 표시 등)
- `isNewCustomer` → `false` 전환

#### 4. "무시하고 계속" 동작 (기본)
- 알림은 표시만, 별도 액션 없이 예약 진행
- 예약 생성 시 고객 자동 등록 **하지 않음** (이미 존재하므로)
- 기존 `handleSubmit`의 `getByPhone` 체크 로직이 이를 처리

---

## 수정 대상 파일

| 파일 | 변경 내용 |
|------|----------|
| `src/components/reservation/AppointmentForm.tsx` | 전화번호 debounce 조회 + 인라인 알림 UI |

### 백엔드 변경: 없음
- `get_customer_by_phone` 커맨드 이미 존재
- `create_customer` 중복 검사 이미 존재

---

## UI 설계

### 인라인 알림 (기존 고객 발견 시)

```
┌─────────────────────────────────────────────┐
│ 📞 010-1234-5678                            │  ← 전화번호 입력 필드
└─────────────────────────────────────────────┘
┌─────────────────────────────────────────────┐
│ ℹ️ 이 번호로 등록된 고객이 있습니다          │
│    010-1234-5678 · 홍길동 · 3회 방문         │
│                        [기존 고객 선택]      │
└─────────────────────────────────────────────┘
┌─────────────────────────────────────────────┐
│ 고객 이름을 입력하세요                       │  ← 이름 입력 필드
└─────────────────────────────────────────────┘
```

---

## 구현 상태

### Step 1: 전화번호 debounce 조회 ✅ 완료
- `AppointmentForm`에 `existingCustomer` 상태 추가
- `useCallback`으로 `checkExistingCustomer` 함수 구현
- `useEffect`로 `formData.customerPhone` 변경 감지 → 500ms debounce → `getByPhone` 호출
- 조건: 신규 고객 모드 + 전화번호 4자리 이상

### Step 2: 인라인 알림 UI ⏳ 미구현
- 전화번호 입력 필드와 이름 입력 필드 사이에 알림 영역 추가
- `existingCustomer`가 존재하면 표시
- UI 디자인은 상단 UI 설계 섹션 참조

### Step 3: "기존 고객 선택" 액션 ⏳ 미구현
- 기존 `handleSelectCustomer` 로직 재활용
- 폼 데이터 채우고 `isNewCustomer` → `false` 전환

---

## 변경 이력

| 날짜 | 내용 |
|------|------|
| 2026-01-29 | SPEC 문서 작성, Step 1 debounce 조회 구현 완료 |
